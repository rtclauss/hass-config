################################################################
## Packages / Light
################################################################

################################################
## Customize
################################################

homeassistant:
  customize:
    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: "light"

      expose: &expose
        <<: *customize
        haaska_hidden: false
        homebridge_hidden: false

    ################################################
    ## Automations
    ################################################
    automation.deck_light_auto_on:
      <<: *customize
      friendly_name: "Turn on deck lights automatically"
      icon: mdi:nature-people

    automation.front_door_light_auto_off:
      <<: *customize
      friendly_name: "Turn off front door light automatically"
      icon: mdi:home

    automation.front_door_light_auto_on:
      <<: *customize
      friendly_name: "Turn on front door light automatically"
      icon: mdi:home

    automation.hallway_light_toggle_at_night:
      <<: *customize
      friendly_name: "Toggle hallway light automatically at night"
      icon: mdi:ceiling-light

    automation.owner_suite_light_auto_on:
      <<: *customize
      friendly_name: "Turn on master bedroom lights automatically"
      icon: mdi:ceiling-light

    automation.owner_suite_light_auto_off:
      <<: *customize
      friendly_name: "Turn off master bedroom lights automatically"
      icon: mdi:ceiling-light

    automation.office_light_on_at_night:
      <<: *customize
      friendly_name: "Turn on office light automatically at night"
      icon: mdi:ceiling-light

    automation.office_light_off_at_night:
      <<: *customize
      friendly_name: "Turn off office light automatically"
      icon: mdi:ceiling-light

    automation.toggle_living_room:
      <<: *customize
      friendly_name: "Toggle Living Room"

    automation.button_reset_basement:
      <<: *customize
      friendly_name: "Button Reset Basement"

    automation.turn_off_all_lights_when_bed_off:
      <<: *customize
      friendly_name: "Turn off all lights when bedroom lights turn off"
      icon: mdi:bed

    ################################################
    ## Binary Sensors
    ################################################

    ################################################
    ## Device Trackers
    ################################################

    ################################################
    ## Groups
    ################################################

    ################################################
    ## Input Boolean
    ################################################
    input_boolean.deck_auto_on:
      <<: *customize
      friendly_name: "Deck Light Automatically Turned on"
      icon: mdi:nature-people
      hidden: true

    input_boolean.front_door_auto_on:
      <<: *customize
      friendly_name: "Front Door Light Automatically Turned on"
      icon: mdi:home
      hidden: true

    input_boolean.owner_suite_bathroom_auto_on:
      <<: *customize
      friendly_name: "Owner Suite Lights Automatically Turned on"
      icon: mdi:toilet
      hidden: true

    ################################################
    ## Input Numbers
    ################################################

    ################################################
    ## Light
    ################################################
    light.bedroom_lamp:
      <<: *customize
      friendly_name: "Bedroom Lamp"
      icon: mdi:bed

    light.bedroom_lamp_2:
      <<: *customize
      friendly_name: "Bedroom Lamp"
      icon: mdi:bed

    light.christmas_lights:
      <<: *customize
      friendly_name: "Christmas Lights"
      icon: mdi:led-on

    light.front_door:
      <<: *customize
      friendly_name: "Front Door"
      icon: mdi:home

    light.guest_ceiling:
      <<: *customize
      friendly_name: "Guest Ceiling Light"
      icon: mdi:home

    light.guest_left_lamp:
      <<: *customize
      friendly_name: "Guest Left Lamp"
      icon: mdi:home

    light.guest_right_lamp:
      <<: *customize
      friendly_name: "Guest Right Lamp"
      icon: mdi:home

    light.hallway_light:
      <<: *customize
      friendly_name: "Hallway"
      icon: mdi:ceiling-light

    light.kitchen_sink_overhead:
      <<: *customize
      friendly_name: "Kitchen Sink"
      icon: mdi:countertop

    light.kitchen_table:
      <<: *customize
      friendly_name: "Kitchen Table"
      icon: mdi:ceiling-light

    light.office_red_lava_lamp:
      <<: *customize
      friendly_name: "Lava Lamp"
      icon: mdi:lava-lamp

    light.left_lamp:
      <<: *customize
      friendly_name: "Living Room Left"
      icon: mdi:lamp

    # light.living_room_lamps:
    #   <<: *customize
    #   friendly_name: "Living Room Lights"
    #   icon: mdi:television

    # light.living_room_lamps_except_tv:
    #   <<: *customize
    #   friendly_name: "Living Room Lights except TV Bias"
    #   icon: mdi:television

    light.owner_suite:
      <<: *customize
      friendly_name: "Master Bedroom"
      icon: mdi:bed

    light.office_lamp:
      <<: *customize
      friendly_name: "Office Lamp"
      icon: mdi:desktop-tower

    light.pendant_lamp:
      <<: *customize
      friendly_name: "Pendant Lamp"
      icon: mdi:ceiling-light

    light.right_lamp:
      <<: *customize
      friendly_name: "Living Room Right"
      icon: mdi:lamp

    light.basement_tv_bias:
      <<: *customize
      friendly_name: "TV Bias"
      icon: mdi:television

    ################################################
    ## Proximity
    ################################################

    ################################################
    ## Scenes
    ################################################
    scene.night_arrive_home:
      <<: *customize
      friendly_name: Nighttime Arrive Home
      hidden: true

    scene.leave_home:
      <<: *customize
      hidden: true

    scene.bedroom_prep:
      <<: *customize
      friendly_name: Bedroom Prep

    scene.outside_ambiance:
      <<: *customize
      friendly_name: Outside Ambiance

    scene.reset_bedroom:
      <<: *customize
      friendly_name: Reset Bedroom

    scene.scene_reset_basement:
      <<: *customize
      friendly_name: Reset Basement

    scene.scene_reset_bedroom:
      <<: *customize
      friendly_name: Scene Reset Bedroom

    ################################################
    ## Scripts
    ################################################
    script.reset_basement:
      <<: *customize
      friendly_name: "Script Reset Basement"

    ################################################
    ## Sensors
    ################################################

    ################################################
    ## Switches
    ################################################

    light.deck:
      <<: *customize
      friendly_name: "Deck"
      icon: mdi:nature-people

    switch.front_door:
      <<: *customize
      friendly_name: "Front Door"
      icon: mdi:home

    ################################################
    ## Thermostats
    ################################################

    ################################################
    ## Zone
    ################################################

################################################
## Adaptive Lighting
################################################
# adaptive_lighting:
#   - name: "Rest of House"
#     lights:
#       - light.kitchen_sink
#       - light.den_all
#       - light.living_room_lamps
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 20
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

#   - name: "Bedroom"
#     lights:
#       - light.owner_suite_all
#       - light.owner_suite_bathroom_lights
#       - light.owner_suite_lamps
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 10
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

#   - name: "Hallways"
#     lights:
#       - light.hall_all_downlights
#       - light.hall_main_foyer
#       - light.hall_upstairs_lights
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 10
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

#   - name: "Basement"
#     lights:
#       - light.basement_great_room
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 10
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

################################################
## Automation
################################################
automation:
  - id: basement_lights_auto_on
    alias: basement_lights_auto_on
    trigger:
      - trigger: state
        entity_id: binary_sensor.basement_landing_occupancy
        to: "on"
    condition:
      - alias: "Not in bed"
        condition: state
        entity_id:
          - binary_sensor.bayesian_bed_occupancy
          # - input_boolean.chatgpt_bed_occupied
        state: "off"
      - not:
          - alias: "watching something"
            condition: state
            entity_id: media_player.basement
            state: "playing"
      - condition: state
        entity_id:
          - input_boolean.bayesian_zeke_home
        state: "on"
    action:
      - action: adaptive_lighting.apply
        data:
          lights:
            - light.basement_great_room
          entity_id: switch.adaptive_lighting_basement
          adapt_brightness: true
          adapt_color: true
          turn_on_lights: true
      # - action: light.turn_on
      #   data:
      #     entity_id:
      #       - light.basement_great_room_east_and_middle_switch
      #       - light.basement_north_hallway_switch
      #       - light.basement_landing_switch
      #       - light.basement_great_room_west_switch
      #       - light.basement_great_room_landing_switch_2
      #       - light.basement_great_room

  - id: cpap_on_lights_off
    alias: cpap_on_lights_off
    trigger:
      - trigger: numeric_state
        entity_id: sensor.owner_suite_cpap_plug_power
        above: 1.3
        for:
          seconds: 10
    condition:
      - alias: "Already up"
        condition: state
        entity_id: input_boolean.wakeup_alarm_firing
        state: "off"
      - or:
          - alias: "after sunset"
            condition: sun
            after: sunset
          - alias: "before sunrise"
            condition: sun
            before: sunrise
    action:
      - action: light.turn_off
        data:
          entity_id:
            - light.owner_suite_lamps
            - light.bed_lightstrip

  # - id: deck_light_auto_off
  #   alias: deck_light_auto_off
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.tiki_room_deck_contact
  #       to: "off"
  #       for:
  #         seconds: 30
  #     - platform: state
  #       entity_id: binary_sensor.kitchen_deck_contact
  #       to: "off"
  #       for:
  #         seconds: 30
  #   condition:
  #     condition: state
  #     entity_id: input_boolean.deck_auto_on
  #     state: "on"
  #   action:
  #     - action: homeassistant.turn_off
  #       data:
  #         entity_id:
  #           - switch.deck
  #           - light.deck_string
  #     - action: input_boolean.turn_off
  #       data:
  #         entity_id: input_boolean.deck_auto_on

  # - alias: _DEBUG • Who turned things OFF
  #   mode: parallel
  #   trigger:
  #     - platform: event
  #       event_type: call_service
  #       event_data:
  #         domain: homeassistant
  #         action: turn_off
  #     - platform: event
  #       event_type: call_service
  #       event_data:
  #         domain: light
  #         action: turn_off
  #   variables:
  #     _dom: "{{ trigger.event.data.domain  | default('n/a') | string }}"
  #     _svc: "{{ trigger.event.data.service | default('n/a') | string }}"
  #     _sd: "{{ trigger.event.data.service_data | default({}) | tojson }}"
  #     _uid: "{{ trigger.event.context.user_id | default('n/a') | string }}"
  #     _ctx: "{{ trigger.event.context.id | default('n/a') | string }}"
  #     _par: "{{ trigger.event.context.parent_id | default('n/a') | string }}"
  #   action:
  #     - action: persistent_notification.create
  #       data:
  #         title: "OFF trace"
  #         message: >-
  #           {{ now() }} → {{ _dom }}.{{ _svc }}
  #           data={{ _sd }}
  #           user_id={{ _uid }}
  #           ctx={{ _ctx }} parent={{ _par }}
  #     - action: logbook.log
  #       data:
  #         name: "OFF trace"
  #         message: >-
  #           {{ _dom }}.{{ _svc }} {{ _sd }}
  #           user_id={{ _uid }} ctx={{ _ctx }} parent={{ _par }}

  - id: deck_light_auto_on
    alias: deck_light_auto_on
    trigger:
      - trigger: state
        entity_id: binary_sensor.tiki_room_deck_contact
        to: "on"
      - trigger: state
        entity_id: binary_sensor.kitchen_deck_contact
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: sun
          after: sunset
          after_offset: -02:00:00
        - condition: state
          entity_id: light.deck
          state: "off"
          enabled: false
        - condition: state
          entity_id: light.deck_string
          state: "off"
    action:
      - action: light.turn_on
        data:
          entity_id:
            - light.deck_string
      # - action: input_boolean.turn_on
      #   data:
      #     entity_id: input_boolean.deck_auto_on

  - id: front_door_light_auto_toggle
    alias: front_door_light_auto_toggle
    trigger:
      - trigger: state
        entity_id: binary_sensor.main_foyer_front_door_contact
        to: "off"
        for:
          minutes: 30
        id: door-closed
      - trigger: state
        entity_id: binary_sensor.main_foyer_front_door_contact
        to: "on"
        id: door-opened
    condition:
      - or:
          - alias: "after sunset"
            condition: sun
            after: sunset
            after_offset: "-00:45:00"
          - alias: "before sunrise"
            condition: sun
            before: sunrise
            before_offset: "-00:45:00"
      # condition: state
      # entity_id: input_boolean.front_door_auto_on
      # state: "on"
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: door-closed
            sequence:
              # TODO maybe don't turn off the lights.
              # - action: light.turn_off
              #   data:
              #     entity_id: light.outside_front_hue
              - action: input_boolean.turn_off
                data:
                  entity_id: input_boolean.front_door_auto_on
          - conditions:
              - condition: trigger
                id: door-opened
            sequence:
              - action: light.turn_on
                data:
                  entity_id:
                    - light.outside_front_hue
                    - light.hall_transition
                    - light.hall_main_foyer
              - action: input_boolean.turn_on
                data:
                  entity_id: input_boolean.front_door_auto_on

  - id: front_lights_toggle
    alias: front_lights_toggle
    trigger:
      - trigger: sun
        event: sunrise
        offset: "00:00:00"
        id: sunrise
      - trigger: sun
        event: sunset
        offset: "-01:45:00"
        id: sunset
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: sunrise
            sequence:
              - action: light.turn_off
                data:
                  transition: 300
                target:
                  entity_id:
                    - light.outside_front_hue
                    - light.outside_north_west_garage
                    - light.outside_south_west_garage
                    - light.outside_front_door
      - choose:
          - conditions:
              - condition: trigger
                id: sunset
            sequence:
              - action: light.turn_on
                data:
                  transition: 300
                  brightness_pct: 100
                target:
                  entity_id:
                    - light.outside_front_hue
                    - light.outside_north_west_garage
                    - light.outside_south_west_garage
                    - light.outside_front_door

  - id: garage_entry_door_light_auto_toggle
    alias: garage_entry_light_auto_toggle
    trigger:
      - trigger: state
        entity_id: binary_sensor.hall_garage_entry_contact
        to: "off"
        for:
          minutes: 5
        id: door-closed
      - trigger: state
        entity_id: binary_sensor.hall_garage_entry_contact
        to: "on"
        id: door-opened
    condition: []
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: door-closed
            sequence:
              - action: light.turn_off
                data:
                  entity_id:
                    - light.hall_foyer_switch
                    - light.hall_transition
                    - light.hall_garage_laundry_switch
                    - light.garage_overhead_switch
      - choose:
          - conditions:
              - condition: trigger
                id: door-opened
            sequence:
              - action: light.turn_on
                data:
                  entity_id:
                    - light.hall_foyer_switch
                    - light.hall_transition
                    - light.hall_garage_laundry_switch
                    - light.garage_overhead_switch

  - id: guest_room_ceiling_lights_on_off
    alias: guest_room_ceiling_lights_on_off
    trigger:
      - trigger: event
        event_type: zha_event
        event_data:
          device_ieee: "00:15:8d:00:01:f3:78:cc"
          command: "hold"
    action:
      - action: homeassistant.toggle
        data:
          entity_id:
            - light.guest_ceiling

  - id: guest_room_lights_on_off
    alias: guest_room_lights_on_off
    trigger:
      - trigger: event
        event_type: zha_event
        event_data:
          device_ieee: "00:15:8d:00:01:f3:78:cc"
          command: "click"
          args:
            click_type: "single"
    action:
      - action: homeassistant.toggle
        data:
          entity_id:
            - light.guest_side_lamps

  - id: hallway_light_toggle_at_night
    alias: hallway_light_toggle_at_night
    trace:
      stored_traces: 50
    trigger:
      - trigger: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
        to: "on"
        id: main-motion-sensed
      - trigger: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
        to: "off"
        id: main-motion-not-detected
      - trigger: state
        entity_id:
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "on"
        id: upstairs-motion-sensed
      - trigger: state
        entity_id:
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "off"
        id: upstairs-motion-not-detected
    condition:
      - condition: or
        conditions:
          - condition: sun
            after: sunset
            before_offset: "-1:30:00"
          - condition: sun
            before: sunrise
            after_offset: "0:30:00"
      - condition: state
        entity_id:
          - input_boolean.guest_mode
        state: "off"
      - condition: state
        entity_id:
          - input_boolean.bayesian_zeke_home
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: main-motion-sensed
              - condition: or
                conditions:
                  - condition: state
                    entity_id:
                      - binary_sensor.bayesian_bed_occupancy
                      # - input_boolean.chatgpt_bed_occupied
                    state: "off"
                  - condition: state
                    entity_id:
                      - input_boolean.guest_mode
                    state: "on"
            sequence:
              - action: adaptive_lighting.apply
                data:
                  lights:
                    - light.hall_all
                  entity_id: switch.adaptive_lighting_hallway
                  adapt_brightness: true
                  adapt_color: true
                  turn_on_lights: true
              # - action: light.turn_on
              #   data:
              #     entity_id:
              #       - light.hall_light_switch
              #       - light.hall_transition_switch
              #     transition: 2.5
              # Should do this automatically
              # kelvin: "{{ states('sensor.circadian_temperature') | int }}"
              # brightness_pct: 2
          - conditions:
              - condition: trigger
                id: main-motion-not-detected
              - condition: state
                entity_id:
                  - binary_sensor.bayesian_bed_occupancy
                  # - input_boolean.chatgpt_bed_occupied
                state: "on"
            sequence:
              - delay:
                  minutes: 3
              # - condition: >-
              #     {{ states('binary_sensor.hall_upstairs_motion_occupancy') == "off" and states('binary_sensor.hall_main_foyer_motion_occupancy') == "off" }}
              - action: light.turn_off
                data:
                  entity_id:
                    - light.hall_all
                    - light.garage_overhead_switch
                  transition: 5
          - conditions:
              - condition: trigger
                id: main-motion-not-detected
              - condition: state
                entity_id:
                  - binary_sensor.bayesian_bed_occupancy
                  # - input_boolean.chatgpt_bed_occupied
                state: "off"
            sequence:
              - delay:
                  minutes: 15
              # - condition: >-
              #     {{ states('binary_sensor.hall_upstairs_motion_occupancy') == "off" and states('binary_sensor.hall_main_foyer_motion_occupancy') == "off" }}
              - action: light.turn_off
                data:
                  entity_id:
                    - light.hall_all
                    - light.garage_overhead_switch
                  transition: 5
          - conditions:
              - condition: trigger
                id: upstairs-motion-sensed
              - condition: or
                conditions:
                  - condition: state
                    entity_id:
                      # - binary_sensor.bayesian_bed_occupancy
                      - input_boolean.chatgpt_bed_occupied
                    state: "off"
                  - condition: state
                    entity_id:
                      - input_boolean.guest_mode
                    state: "on"
            sequence:
              - action: adaptive_lighting.apply
                data:
                  lights:
                    - light.hall_all
                  entity_id: switch.adaptive_lighting_hallway
                  adapt_brightness: true
                  adapt_color: true
                  turn_on_lights: true
              # - action: light.turn_on
              #   data:
              #     entity_id:
              #       - light.hall_upstairs_switch
              #       - light.hall_stairway
              #     transition: 2.5
              # Should do this automatically
              # kelvin: "{{ states('sensor.circadian_temperature') | int }}"
              # brightness_pct: 2
          - conditions:
              - condition: trigger
                id: upstairs-motion-not-detected
              - condition: state
                entity_id:
                  # - binary_sensor.bayesian_bed_occupancy
                  - input_boolean.chatgpt_bed_occupied
                state: "off"
            sequence:
              - delay:
                  minutes: 15
              # - condition: >-
              #     {{ states('binary_sensor.hall_upstairs_motion_occupancy') == "off" and states('binary_sensor.hall_main_foyer_motion_occupancy') == "off" }}
              - action: light.turn_off
                data:
                  entity_id:
                    - light.hall_all
                  transition: 5
          - conditions:
              - condition: trigger
                id: upstairs-motion-not-detected
              - condition: state
                entity_id:
                  # - binary_sensor.bayesian_bed_occupancy
                  - input_boolean.chatgpt_bed_occupied
                state: "on"
            sequence:
              - delay:
                  minutes: 3
              # - condition: >-
              #     {{ states('binary_sensor.hall_upstairs_motion_occupancy') == "off" and states('binary_sensor.hall_main_foyer_motion_occupancy') == "off" }}
              - action: light.turn_off
                data:
                  entity_id:
                    - light.hall_all
                  transition: 5

  - id: in_bed_turn_off_other_lights
    alias: in_bed_turn_off_other_lights
    trigger:
      - trigger: state
        entity_id:
          # - binary_sensor.bayesian_bed_occupancy
          - input_boolean.chatgpt_bed_occupied
        to: "on"
        from: "off"
        for:
          minutes: 10
    condition:
      - condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
      - or:
          - condition: sun
            after: sunset
            after_offset: "-0:30:00"
          - condition: sun
            before: sunrise
            before_offset: "+0:10:00"
    action:
      - action: script.lights_off_except
        data:
          exclude_lights:
            - light.outside_front_hue
            - light.owner_suite_lamps
            - light.bed_lightstrip
            - light.owner_suite_lamp_bulb_1
            - light.owner_suite_lamp_bulb_2
            - light.outside_north_west_garage
            - light.outside_south_west_garage
            - light.outside_front_door
            # - light.owner_suite_all
          transition: 120

          # binary_sensor.presense

  - id: kitchen_lights_toggle
    alias: kitchen_lights_toggle
    trigger:
      - trigger: state
        entity_id:
          - binary_sensor.kitchen_motion_occupancy
        to: "on"
        id: kitchen-occupied
      - trigger: state
        entity_id:
          - binary_sensor.kitchen_motion_occupancy
        to: "off"
        for:
          minutes: 60
        id: kitchen_unoccupied
    condition:
      - condition: state
        entity_id:
          - input_boolean.guest_mode
        state: "off"
      - condition: state
        entity_id:
          - input_boolean.bayesian_zeke_home
        state: "on"
    action:
      - choose:
          # IF lunch
          - conditions:
              - condition: trigger
                id: kitchen-occupied
              - condition: template
                value_template: "{{ now().hour >= 11 and now().hour < 14 }}"
            sequence:
              - action: adaptive_lighting.apply
                data:
                  lights:
                    - light.kitchen_all
                    - light.kitchen_sink_overhead
                    - light.kitchen_overhead
                  entity_id: switch.adaptive_lighting_kitchen
                  adapt_brightness: true
                  adapt_color: true
                  turn_on_lights: true
              # - action: light.turn_on
              #   target:
              #     entity_id:
              #       - light.kitchen_overhead_lights_switch
              #       - light.kitchen_sink_light_switch
              #       - light.kitchen_all
          # ELIF dinner
          - conditions:
              - condition: trigger
                id: kitchen-occupied
              - condition: template
                value_template: "{{ now().hour >= 17 and now().hour < 20 }}"
            sequence:
              - action: adaptive_lighting.apply
                data:
                  lights:
                    - light.kitchen_all
                    - light.kitchen_sink_overhead
                    - light.kitchen_overhead
                  entity_id: switch.adaptive_lighting_adapt_brightness_kitchen
                  adapt_brightness: true
                  adapt_color: true
                  turn_on_lights: true
          - conditions:
              - condition: trigger
                id: kitchen-unoccupied
            sequence:
              - action: light.turn_off
                target:
                  entity_id:
                    - light.kitchen_overhead_lights_switch
                    - light.kitchen_sink_light_switch
                    - light.kitchen_all
        default:
          - action: adaptive_lighting.apply
            data:
              lights:
                - light.kitchen_sink_overhead
                - light.kitchen_sink_light_switch
              entity_id: switch.adaptive_lighting_kitchen
              adapt_brightness: true
              adapt_color: true
              turn_on_lights: true
          # - action: light.turn_on
          #   target:
          #     entity_id:
          #       - light.kitchen_sink_light_switch
          #       - light.kitchen_sink_overhead

  # - id: kitchen_lights_off
  #   alias: kitchen_lights_off
  #   trigger:
  #     - platform: state
  #       entity_id:
  #         - binary_sensor.kitchen_motion_occupancy
  #       to: "off"
  #       for:
  #         minutes: 60
  #       id: kitchen_unoccupied
  #   action:
  #     - action: light.turn_off
  #       target:
  #         entity_id: light.kitchen_all

  - id: up_enable_owner_bedroom_light_auto_off
    alias: up_enable_owner_bedroom_light_auto_off
    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.owner_suite_bathroom_room_occupancy
    condition:
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: state
        entity_id: light.owner_suite_lamps
        state: "on"
      - condition: state
        # entity_id: binary_sensor.bayesian_bed_occupancy
        entity_id: input_boolean.chatgpt_bed_occupied
        state: "off"
        # enabled: false
    actions:
      - action: input_boolean.turn_on
        data:
          entity_id: input_boolean.owner_suite_bedroom_auto_on

  - id: owner_suite_bath_light_auto_off_in_bed
    alias: owner_suite_bath_light_auto_off_in_bed
    triggers:
      - trigger: state
        # entity_id: binary_sensor.bayesian_bed_occupancy
        entity_id: input_boolean.chatgpt_bed_occupied
        to: "on"
        for:
          minutes: 2
    condition: []
    actions:
      - action: light.turn_off
        data:
          entity_id:
            - light.owner_suite_bathroom_vanity
            - light.owner_suite_bathroom_tub_switch
            - light.owner_suite_bathroom_shower_switch
            - light.owner_suite_bathroom_lights

  - id: owner_suite_bath_light_auto_toggle
    alias: owner_suite_bath_light_auto_toggle
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.owner_suite_bathroom_room_occupancy
        to: "on"
        id: motion_detected
      - trigger: state
        entity_id: binary_sensor.owner_suite_bathroom_room_occupancy
        to: "off"
        for:
          minutes: 25
        id: motion_cleared
    # condition:
    #   condition: and
    #   conditions:
    #     - condition: sun
    #       after: sunset
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: motion_detected
            sequence:
              # - action: adaptive_lighting.apply
              #   data:
              #     lights:
              #       - light.owner_suite_bathroom_tub_switch
              #       - light.owner_suite_bathroom_shower_switch
              #     entity_id: switch.adaptive_lighting_owner_suite
              #     adapt_brightness: true
              #     adapt_color: true
              #     turn_on_lights: true
              - action: light.turn_on
                data:
                  entity_id:
                    # - light.owner_suite_bathroom_tub_switch
                    # - light.owner_suite_bathroom_shower_switch
                    - light.owner_suite_bathroom_lights
                    - light.owner_suite_bathroom_vanity
          - conditions:
              - condition: trigger
                id: motion_cleared
            sequence:
              - action: light.turn_off
                data:
                  entity_id:
                    - light.owner_suite_bathroom_vanity
                    - light.owner_suite_bathroom_tub_switch
                    - light.owner_suite_bathroom_shower_switch
                    - light.owner_suite_bathroom_lights

  - id: owner_suite_light_auto_off
    alias: owner_suite_light_auto_off
    triggers:
      - trigger: state
        entity_id: binary_sensor.bedroom_occupancy
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.owner_suite_bedroom_auto_on
          state: "on"
        - condition: state
          # entity_id: binary_sensor.bayesian_bed_occupancy
          entity_id: input_boolean.chatgpt_bed_occupied
          state: "off"
          # enabled: false
    actions:
      - action: light.turn_off
        data:
          entity_id:
            - light.owner_suite_lamps
            - light.owner_suite_ceiling
            - light.owner_suite_closet
            - light.bed_lightstrip
      - action: fan.turn_off
        target:
          entity_id: fan.owner_suite
      - action: input_boolean.turn_off
        data:
          entity_id: input_boolean.owner_suite_bedroom_auto_on

  - id: owner_suite_light_auto_off_in_morning
    alias: owner_suite_light_auto_off_in_morning
    trigger:
      - trigger: state
        entity_id: binary_sensor.bedroom_occupancy
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: time
          after: "00:06:00"
          before: "12:00:00"
        - condition: state
          # entity_id: binary_sensor.bayesian_bed_occupancy
          entity_id: input_boolean.chatgpt_bed_occupied
          state: "off"
          # enabled: false
    action:
      - action: fan.turn_off
        target:
          entity_id: fan.owner_suite
      - action: light.turn_off
        data:
          entity_id:
            - light.owner_suite_lamps
            - light.owner_suite_ceiling
            - light.owner_suite_closet
            - light.bed_lightstrip

  # - id: owner_suite_light_auto_boolean_off
  #   alias: owner_suite_light_auto_boolean_off
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.bedroom_occupancy
  #       to: "off"
  #   condition:
  #     condition: and
  #     conditions:
  #       - condition: state
  #         entity_id: input_boolean.owner_suite_bedroom_auto_on
  #         state: "on"
  #       - condition: state
  #         entity_id: binary_sensor.bayesian_bed_occupancy
  #         state: "off"
  #         # enabled: false
  #   action:
  #     - action: input_boolean.turn_off
  #       data:
  #         entity_id: input_boolean.owner_suite_bedroom_auto_on

  - id: owner_suite_light_auto_on
    alias: owner_suite_light_auto_on
    trace:
      stored_traces: 20
    trigger:
      - trigger: state
        entity_id: binary_sensor.bedroom_occupancy
        to: "on"
      - trigger: state
        entity_id: binary_sensor.presense
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: device_tracker.bayesian_zeke_home
          zone: zone.home
        - condition: state
          entity_id: light.owner_suite_lamps
          state: "off"
        - condition: state
          # entity_id: binary_sensor.bayesian_bed_occupancy
          entity_id: input_boolean.chatgpt_bed_occupied
          state: "off"
          # enabled: false
    action:
      - action: light.turn_on
        data:
          entity_id:
            - light.owner_suite_lamps
            - light.bed_lightstrip
      - action: input_boolean.turn_on
        data:
          entity_id: input_boolean.owner_suite_bedroom_auto_on

  # TODO remove as no longer needed?

  # - id: office_light_on_at_night
  #   alias: office_light_on_at_night
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.office_motion_occupancy
  #       to: "on"
  #   condition:
  #     condition: sun
  #     before: sunrise
  #     after_offset: "-0:30:00"
  #   action:
  #     - action: light.turn_on
  #       data_template:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling
  #         kelvin: >-
  #           {{ state_attr('switch.adaptive_lighting_rest_of_house','color_temp_kelvin') | int }}
  #         brightness_pct: >-
  #           {{ state_attr('switch.adaptive_lighting_rest_of_house', 'brightness_pct') | int }}

  # - id: office_light_off_at_night
  #   alias: office_light_off_at_night
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.office_motion_occupancy
  #       to: "off"
  #   condition:
  #     condition: sun
  #     before: sunrise
  #     after_offset: "-0:30:00"
  #   action
  #     - action: input_boolean.turn_off
  #       data:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling

  # - id: reset_office_light_at_night
  #   alias: reset_office_light_at_night
  #   trigger:
  #     - platform: time
  #       at: "03:48:00"
  #   action:
  #     - action: light.turn_on
  #       data:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling
  #         brightness: 1
  #     - delay:
  #         seconds: 10
  #     - action: light.turn_off
  #       data:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling

  - alias: toggle_living_room
    id: toggle_living_room
    trigger:
      - trigger: state
        entity_id:
          - binary_sensor.living_room_button_push
    action:
      - action: light.toggle
        entity_id: light.dining_room_lamps
        data:
          transition: 5

  - alias: toggle_kitchen
    id: toggle_kitchen
    trigger:
      - trigger: state
        entity_id:
          - binary_sensor.kitchen_button
    action:
      - action: light.toggle
        entity_id: light.kitchen_table
        data:
          transition: 5

  - alias: toggle_office
    id: toggle_office
    trigger:
      - trigger: event
        event_type: zha_event
        event_data:
          device_ieee: "00:15:8d:00:02:13:90:e9"
          command: "attribute_updated"
    action:
      - action: light.toggle
        entity_id: light.office_all
        data:
          transition: 5

  - alias: transition_on_lights_when_home_near_sunset
    id: transition_on_lights_when_home_near_sunset
    trigger:
      platform: sun
      event: sunset
      offset: "-02:00:00"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: person.ryan
          zone: zone.home
        # - condition: numeric_state
        #   entity_id: sensor.tomorrow_io_the_brewery_cloud_cover
        #   below: 20
    action:
      - action: script.turn_on
        data:
          entity_id: script.night_tv_mode_switches
      - action: light.turn_on
        entity_id:
          - light.kitchen_sink_light_switch
          - light.kitchen_sink_overhead
          - light.hall_stairway
          # - light.hall_all_downlights
          - light.living_room_wall_switch
          - light.den_wall_switch
          # - light.kitchen_table
          # - light.living_room_lamps
        data:
          # Hour-long transition before sunset.
          transition: 5400

  - alias: transition_on_lights_early_when_cloudy_when_home_near_sunset
    id: transition_on_lights_early_when_cloudy_when_home_near_sunset
    trigger:
      platform: sun
      event: sunset
      offset: "-04:00:00"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: person.ryan
          zone: zone.home
        - condition: numeric_state
          entity_id: sensor.tomorrow_io_the_brewery_cloud_cover
          above: 20
    action:
      - action: light.turn_on
        entity_id:
          - light.kitchen_sink_light_switch
          - light.kitchen_sink_overhead
          - light.hall_main_foyer
          - light.hall_garage_laundry_switch
          - light.hall_transition_switch
          # - light.hall_all_downlights
          - light.hall_upstairs_switch
          - light.living_room_wall_switch
          - light.den_wall_switch
        data:
          # Hour-long transition before sunset.
          transition: 5400

  - alias: turn_off_alarm_firing
    id: turn_off_alarm_firing
    trigger:
      - trigger: time
        at: "14:34:56"
    action:
      - alias: "Turn off Alarm Boolean"
        action: input_boolean.turn_off
        target:
          entity_id: input_boolean.wakeup_alarm_firing

  # TODO figure out a way to avoid the: motion downstairs but upstairs has turned off so I'm going to turn off everything.
  - alias: toggle_hallway_day
    id: toggle_hallway_day
    trace:
      stored_traces: 20
    trigger:
      - trigger: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
        to: "on"
        id: main-motion-sensed
      - trigger: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
        to: "off"
        for:
          minutes: 15
        id: main-motion-not-detected
      - trigger: state
        entity_id:
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "on"
        id: upstairs-motion-sensed
      - trigger: state
        entity_id:
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "off"
        for:
          minutes: 15
        id: upstairs-motion-not-detected
    condition:
      - condition: sun
        after: sunrise
        before: sunset
      - condition: state
        entity_id:
          - input_boolean.guest_mode
        state: "off"
      - condition: state
        entity_id:
          - input_boolean.bayesian_zeke_home
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: main-motion-sensed
            sequence:
              - action: adaptive_lighting.apply
                data:
                  lights:
                    - light.hall_all
                  entity_id: switch.adaptive_lighting_hallway
                  adapt_brightness: true
                  adapt_color: true
                  turn_on_lights: true
              # - action: light.turn_on
              #   data:
              #     entity_id:
              #       - light.hall_light_switch
              #       - light.hall_transition_switch
              #       # - light.hall_all
              #     # transition: 1.5
          - conditions:
              - condition: trigger
                id: main-motion-not-detected
            sequence:
              # - condition: >-
              #     {{ states('binary_sensor.hall_upstairs_motion_occupancy') == "off" and states('binary_sensor.hall_main_foyer_motion_occupancy') == "off" }}
              - action: light.turn_off
                data:
                  entity_id:
                    - light.hall_foyer_switch
                    - light.hall_transition_switch
                  transition: 5
          - conditions:
              - condition: trigger
                id: upstairs-motion-sensed
            sequence:
              - action: adaptive_lighting.apply
                data:
                  lights:
                    - light.hall_upstairs_switch
                    - light.hall_stairway
                    - light.hall_all
                  entity_id: switch.adaptive_lighting_owner_suite
                  adapt_brightness: true
                  adapt_color: true
                  turn_on_lights: true
              # - action: light.turn_on
              #   data:
              #     entity_id:
              #       - light.hall_upstairs_switch
              #       - light.hall_stairway
              #     transition: 2.5
              # Should do this automatically
              # kelvin: "{{ states('sensor.circadian_temperature') | int }}"
              # brightness_pct: 2
          - conditions:
              - condition: trigger
                id: upstairs-motion-not-detected
            sequence:
              # - condition: >-
              #     {{ states('binary_sensor.hall_upstairs_motion_occupancy') == "off" and states('binary_sensor.hall_main_foyer_motion_occupancy') == "off" }}
              - action: light.turn_off
                data:
                  entity_id:
                    - light.hall_upstairs_switch
                    - light.hall_stairway
                  transition: 5

  # - alias: turn_off_hallway_on_motion_day
  #   id: turn_off_hallway_on_motion_day
  #   trigger:
  #     - platform: state
  #       entity_id:
  #         - binary_sensor.hall_main_foyer_motion_occupancy
  #         - binary_sensor.hall_upstairs_motion_occupancy
  #       to: "off"
  #       for:
  #         seconds: 90
  #   condition:
  #     - condition: sun
  #       after: sunrise
  #       before: sunset
  #   action:
  #     - action: light.turn_off
  #       data:
  #         entity_id:
  #           - light.hall_lights_all

  - alias: turn_off_sleep_mode
    id: turn_off_sleep_mode
    trigger:
      - trigger: time
        at: "08:00:00"
    action:
      - action: switch.turn_off
        data:
          entity_id:
            - switch.sleep_mode

  - alias: button_reset_basement
    id: button_reset_basement
    trigger:
      - trigger: state
        entity_id:
          - binary_sensor.basement_button_hold
    action:
      - action: scene.turn_on
        entity_id: scene.scene_reset_basement
        data:
          transition: 10

  - id: turn_off_all_lights_when_bed_off
    alias: turn_off_all_lights_when_bed_off
    trigger:
      - trigger: state
        entity_id:
          - light.owner_suite_lamps
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: time
          after: "22:00:00"
          before: "06:00:00"
        - condition: state
          # entity_id: binary_sensor.bayesian_bed_occupancy
          entity_id: input_boolean.chatgpt_bed_occupied
          state: "on"
          # enabled: false
          # Don't turn off all the lights if there are guests in the house. Specifically the office/guest room
        - condition: state
          entity_id:
            - input_boolean.guest_mode
          state: "off"
    action:
      - parallel:
          # - action: scene.turn_on
          #   entity_id: scene.good_night
          - action: script.lights_off_except
            data:
              exclude_lights:
                - light.outside_front_hue
                - light.outside_north_west_garage
                - light.outside_south_west_garage
                - light.outside_front_door
              transition: 30
          # - action: light.turn_off
          #   entity_id: "all"
          - action: fan.turn_off
            entity_id:
              - fan.den_ceiling
          - action: switch.turn_on
            data:
              entity_id:
                - switch.sleep_mode
          - action: switch.turn_off
            entity_id:
              - switch.office_red_lava_lamp
          - action: switch.turn_off
            entity_id:
              - switch.northern_light_lava_lamp
          - action: media_player.turn_off
            entity_id:
              - media_player.lg_webos_smart_tv
              - media_player.basement
          - action: script.turn_off_owner_suite_inovelli_switch_leds
        # Only turn on the humidifier when it's winter
        # Not used with whole-home humidifier
        # - condition: and
        #   conditions:
        #     - condition: state
        #       entity_id: sensor.season
        #       state: "winter"
        # - action: switch.turn_on
        #   entity_id:
        #     - switch.humidifier

  - id: turn_on_bedroom_light_when_leave_bathroom
    alias: turn_on_bedroom_light_when_leave_bathroom
    trigger:
      - trigger: state
        entity_id: binary_sensor.bedroom_motion
        to: "on"
      - trigger: state
        entity_id: binary_sensor.presense
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: device_tracker.bayesian_zeke_home
          zone: zone.home
        - condition: state
          entity_id:
            - light.bed_lightstrip
          state: "off"
          enabled: false
        - alias: "condition alias (name)"
          condition: numeric_state
          entity_id: sensor.owner_suite_cpap_plug_power
          below: 1.3
    action:
      - action: adaptive_lighting.apply
        data:
          lights:
            - light.bed_lightstrip
          entity_id: switch.adaptive_lighting_owner_suite
          adapt_brightness: true
          adapt_color: true
          turn_on_lights: true
      # - action: light.turn_on
      #   data:
      #     entity_id: light.owner_suite_lamps
      #     transition: 5
      #     kelvin: >-
      #       {{ state_attr('switch.adaptive_lighting_owner_suite','color_temp_kelvin') | int }}
      #     brightness_pct: >-
      #       {{ state_attr('switch.adaptive_lighting_owner_suite', 'brightness_pct') | int }}

  - id: toggle_on_under_bed_on_motion
    alias: toggle_on_under_bed_on_motion
    trigger:
      - trigger: state
        id: motion_on
        entity_id: binary_sensor.presense
        to: "on"
      - trigger: state
        id: motion_off
        entity_id: binary_sensor.presense
        to: "off"
        for:
          minutes: 60
    condition:
      condition: and
      conditions:
        - alias: "condition alias (name)"
          condition: numeric_state
          entity_id: sensor.owner_suite_cpap_plug_power
          below: 1.3
        - condition: state
          entity_id:
            - light.owner_suite_lamps
            - light.bed_lightstrip
          state: "off"
          enabled: false
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: motion_on
            sequence:
              # TODO maybe don't turn off the lights.
              # - action: light.turn_off
              #   data:
              #     entity_id: light.outside_front_hue
              - action: adaptive_lighting.apply
                data:
                  lights:
                    - light.bed_lightstrip
                  entity_id: switch.adaptive_lighting_owner_suite
                  adapt_brightness: true
                  adapt_color: true
                  turn_on_lights: true
          - conditions:
              - condition: trigger
                id: motion_off
            sequence:
              # TODO maybe don't turn off the lights.
              # - action: light.turn_off
              #   data:
              #     entity_id: light.outside_front_hue
              - action: light.turn_off
                data:
                  entity_id:
                    - light.bed_lightstrip

  - id: turn_off_basement_light_when_dark_in_room
    alias: turn_off_basement_light_when_dark_in_room
    trigger:
      - trigger: state
        entity_id: binary_sensor.downstairs_motion
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: device_tracker.bayesian_zeke_home
          zone: zone.home
        - condition: time
          before: "23:30:00"
        - condition: state
          entity_id: input_boolean.basement_auto_on
          state: "on"
    action:
      - action: switch.turn_off
        data:
          entity_id: light.hall_stairway
      - action: input_boolean.turn_off
        data:
          entity_id: input_boolean.basement_auto_on

  - id: turn_off_office_light_when_not_occupied
    alias: turn_off_office_light_when_not_occupied
    trigger:
      - trigger: state
        entity_id:
          - binary_sensor.office_motion_occupancy
          - binary_sensor.office_occupancy
        to: "off"
        for:
          minutes: 10
    condition:
      condition: and
      conditions:
        # Turn off auto-off when on a trip so it looks like I'm working
        - condition: state
          entity_id: input_boolean.trip
          state: "off"
        - condition: state
          entity_id: binary_sensor.workday_sensor
          state: "off"
        - condition: time
          after: "07:00:00"
          before: "17:00:00"
    action:
      - action: light.turn_off
        data:
          entity_id:
            - light.office_fan_switch
            - light.office_all
            - light.office_ceiling
          transition: 5
      - action: input_boolean.turn_off
        data:
          entity_id: input_boolean.office_auto_on

  - alias: "Tiki Room Animation Speed"
    initial_state: True
    trigger:
      - trigger: state
        entity_id: input_number.tikiroom_ani_speed
    action:
      - action: mqtt.publish
        data_template:
          topic: "leds/tikiroom/set"
          payload: '{"transition":{{ trigger.to_state.state | int }}}'

########################
# Binary Sensors
########################
binary_sensor:

########################
# Device Trackers
########################
device_tracker:

########################
# Groups
########################
group:

########################
# Input Booleans
########################
input_boolean:
  deck_auto_on:
  front_door_auto_on:
  basement_auto_on:
  office_auto_on:
  owner_suite_bedroom_auto_on:
########################
# Input Numbers
########################
input_number:
  tikiroom_ani_speed:
    name: Tiki Room Animation Speed
    initial: 150
    min: 1
    max: 150
    step: 10
########################
# Light
########################
light:
  - platform: group
    name: laundry_room
    entities:
      - light.laundry_room_north
      - light.laundry_room_south

  # - platform: group
  #   name: living_room_all
  #   entities:
  #     - light.living_room_flanking_tv
  #     - light.tv
  #     - light.pendant_lamp

  # - platform: group
  #   name: living_room_all_except_tv
  #   entities:
  #     - light.living_room_flanking_tv
  #     - light.pendant_lamp

  - platform: switch
    name: Office Red Lava Lamp
    entity_id: switch.office_red_lava_lamp

  # - platform: mqtt
  #   schema: json
  #   name: "Tiki Room Strip"
  #   state_topic: "leds/tikiroom"
  #   command_topic: "leds/tikiroom/set"
  #   effect: true
  #   effect_list:
  #     - bpm
  #     - candy cane
  #     - confetti
  #     - cyclon rainbow
  #     - dots
  #     - fire
  #     - glitter
  #     - juggle
  #     - lightning
  #     - noise
  #     - police all
  #     - police one
  #     - rainbow
  #     - rainbow with glitter
  #     - ripple
  #     - sinelon
  #     - solid
  #     - twinkle
  #   brightness: true
  #   #flash: true
  #   rgb: true
  #   optimistic: false
  #   qos: 0

########################
# MQTT
########################
mqtt:
  light:
    - name: "Tiki Room Strip"
      schema: json
      state_topic: "leds/tikiroom"
      command_topic: "leds/tikiroom/set"
      # command_off_template: '{"state": "OFF"}'
      # command_on_template: '{"state": "ON"}'
      # effect: true
      brightness: true
      effect: true
      effect_list:
        - bpm
        - candy cane
        - confetti
        - cyclon rainbow
        - dots
        - fire
        - glitter
        - juggle
        - lightning
        - noise
        - police all
        - police one
        - rainbow
        - rainbow with glitter
        - ripple
        - sinelon
        - solid
        - twinkle
      #brightness: true
      #flash: true
      # color_mode: true
      supported_color_modes: ["rgb", "color_temp"]
      optimistic: false
      qos: 0

########################
# Scenes
########################
scene:
  - name: scene_reset_bedroom
    entities:
      light.owner_suite_ceiling:
        state: "off"
      light.owner_suite_lamps:
        state: "on"
        brightness: 192
        color_temp: 500
      light.bed_lightstrip:
        state: "on"
        brightness: 192
        color_temp: 500

  - name: scene_reset_basement
    entities:
      light.basement_great_room:
        state: "on"
        color_temp: 386
        brightness: 255
      light.basement_tv_bias:
        state: "on"
        hs_color: [360, 100]
        brightness: 128

  - name: scene_reset_outdoors
    entities:
      light.outside_front_hue:
        state: "on"
        hs_color: [28.327, 64.71]
        brightness: 255

  - name: cloudy_arrive_home
    entities:
      light.kitchen_sink_overhead:
        state: "on"
        brightness: 255
      light.hall_transition_switch:
        state: "on"
        brightness: 255
      light.hall_foyer_switch:
        state: "on"
        brightness: 255
      light.hall_upstairs_switch:
        state: "on"
        brightness: 255
      light.den_all:
        state: "on"
      light.hall_stairway:
        state: "on"

  - name: outside_ambiance
    entities:
      light.deck_string:
        state: "on"

  - name: night_arrive_home
    entities:
      light.hall_transition_switch:
        state: "on"
        brightness: 255
      light.hall_main_foyer:
        state: "on"
        brightness: 255
      light.hall_upstairs_switch:
        state: "on"
        brightness: 255
      light.den_all:
        state: "on"
      light.kitchen_sink_overhead:
        state: "on"
        brightness: 255
      light.owner_suite_lamps:
        state: "on"
        brightness: 255
      light.bed_lightstrip:
        state: "on"
        brightness: 255
      switch.front_door:
        state: "on"

  - name: bedroom_prep
    entities:
      light.owner_suite_lamps:
        state: "on"
        brightness_pct: 25
      light.bed_lightstrip:
        state: "on"
        brightness_pct: 25
      cover.owner_suite_blinds:
        state: "closed"
      fan.owner_suite:
        state: "on"
      light.owner_suite_bathroom_lights:
        state: "on"
        brightness: 204
      light.owner_suite_ceiling:
        state: "off"
      # fan.master_bedroom_fan:
      #   state: "on"
      #   speed: "smart"

########################
# Scripts
########################
script:
  reset_basement:
    sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.scene_reset_basement
        data:
          transition: 15

  lights_off_except:
    icon: mdi:home-lightbulb
    mode: queued
    fields:
      exclude_lights:
        description: "Excluded lights as list"
    variables:
      all_other_lights: >
        {%- for device in states.light|rejectattr('entity_id','in', exclude_lights )|rejectattr('state','in','off') %}{%- if loop.first %}{%- else %}, {% endif %}{{ device.entity_id }}{%- if loop.last %}{% endif %}{%- endfor  %}
    sequence:
      # - action: retry.call
      #   data:
      #     action: light.turn_off
      #     expected_state: "off"
      #     transition: >-
      #       {{ transition }}
      #   target:
      #     entity_id: >
      #       {{all_other_lights}}
      - action: light.turn_off
        data:
          entity_id: >
            {{all_other_lights}}
          transition: >-
            {{ transition }}
      - delay:
          seconds: >-
            {{transition + 1 | int}}
      - action: light.turn_off
        data:
          entity_id: >
            {{all_other_lights}}
      - action: logbook.log
        data:
          entity_id: script.lights_off_except
          name: Media resumed
          message: "Turning off all lights except: {{ exclude_lights }}"
          domain: script

########################
# Sensor
########################
sensor:

########################
# Switch
########################
switch:

################################################
## Templates
################################################
template:
  - sensor:
      - name: circadian_brightness
        unit_of_measurement: "%"
        state: >-
          {{ state_attr('switch.adaptive_lighting_hallway', 'brightness_pct') |int }}
      - name: circadian_temperature
        unit_of_measurement: "°K"
        state: >-
          {{ state_attr('switch.adaptive_lighting_hallway', 'color_temp_kelvin') }}

########################
# Zone
########################
zone:
