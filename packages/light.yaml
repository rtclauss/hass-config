################################################################
## Packages / Light
################################################################

################################################
## Customize
################################################

homeassistant:
  customize:
    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: "light"

      expose: &expose
        <<: *customize
        haaska_hidden: false
        homebridge_hidden: false

    ################################################
    ## Automations
    ################################################
    automation.deck_light_auto_on:
      <<: *customize
      friendly_name: "Turn on deck lights automatically"
      icon: mdi:nature-people

    automation.front_door_light_auto_off:
      <<: *customize
      friendly_name: "Turn off front door light automatically"
      icon: mdi:home

    automation.front_door_light_auto_on:
      <<: *customize
      friendly_name: "Turn on front door light automatically"
      icon: mdi:home

    automation.hallway_light_toggle_at_night:
      <<: *customize
      friendly_name: "Toggle hallway light automatically at night"
      icon: mdi:ceiling-light

    automation.owner_suite_light_auto_on:
      <<: *customize
      friendly_name: "Turn on master bedroom lights automatically"
      icon: mdi:ceiling-light

    automation.owner_suite_light_auto_off:
      <<: *customize
      friendly_name: "Turn off master bedroom lights automatically"
      icon: mdi:ceiling-light

    automation.office_light_on_at_night:
      <<: *customize
      friendly_name: "Turn on office light automatically at night"
      icon: mdi:ceiling-light

    automation.office_light_off_at_night:
      <<: *customize
      friendly_name: "Turn off office light automatically"
      icon: mdi:ceiling-light

    automation.toggle_living_room:
      <<: *customize
      friendly_name: "Toggle Living Room"

    automation.button_reset_basement:
      <<: *customize
      friendly_name: "Button Reset Basement"

    automation.turn_off_all_lights_when_bed_off:
      <<: *customize
      friendly_name: "Turn off all lights when bedroom lights turn off"
      icon: mdi:bed

    ################################################
    ## Binary Sensors
    ################################################

    ################################################
    ## Device Trackers
    ################################################

    ################################################
    ## Groups
    ################################################

    ################################################
    ## Input Boolean
    ################################################
    input_boolean.deck_auto_on:
      <<: *customize
      friendly_name: "Deck Light Automatically Turned on"
      icon: mdi:nature-people
      hidden: true

    input_boolean.front_door_auto_on:
      <<: *customize
      friendly_name: "Front Door Light Automatically Turned on"
      icon: mdi:home
      hidden: true

    input_boolean.owner_suite_bathroom_auto_on:
      <<: *customize
      friendly_name: "Owner Suite Lights Automatically Turned on"
      icon: mdi:toilet
      hidden: true

    input_boolean.owner_bath_auto_on:
      <<: *customize
      friendly_name: "Master Bedroom Light Automatically Turned on"
      icon: mdi:bed
      hidden: true

    ################################################
    ## Input Numbers
    ################################################

    ################################################
    ## Light
    ################################################
    light.bedroom_lamp:
      <<: *customize
      friendly_name: "Bedroom Lamp"
      icon: mdi:bed

    light.bedroom_lamp_2:
      <<: *customize
      friendly_name: "Bedroom Lamp"
      icon: mdi:bed

    light.christmas_lights:
      <<: *customize
      friendly_name: "Christmas Lights"
      icon: mdi:led-on

    light.front_door:
      <<: *customize
      friendly_name: "Front Door"
      icon: mdi:home

    light.guest_ceiling:
      <<: *customize
      friendly_name: "Guest Ceiling Light"
      icon: mdi:home

    light.guest_left_lamp:
      <<: *customize
      friendly_name: "Guest Left Lamp"
      icon: mdi:home

    light.guest_right_lamp:
      <<: *customize
      friendly_name: "Guest Right Lamp"
      icon: mdi:home

    light.hallway_light:
      <<: *customize
      friendly_name: "Hallway"
      icon: mdi:ceiling-light

    light.kitchen_sink:
      <<: *customize
      friendly_name: "Kitchen Sink"
      icon: mdi:fridge

    light.kitchen_table:
      <<: *customize
      friendly_name: "Kitchen Table"
      icon: mdi:ceiling-light

    light.office_lava_lamp:
      <<: *customize
      friendly_name: "Lava Lamp"
      icon: mdi:lava-lamp

    light.left_lamp:
      <<: *customize
      friendly_name: "Living Room Left"
      icon: mdi:lamp

    light.living_room_all:
      <<: *customize
      friendly_name: "Living Room Lights"
      icon: mdi:television

    light.living_room_all_except_tv:
      <<: *customize
      friendly_name: "Living Room Lights except TV Bias"
      icon: mdi:television

    light.owner_suite:
      <<: *customize
      friendly_name: "Master Bedroom"
      icon: mdi:bed

    light.office:
      <<: *customize
      friendly_name: "Office"
      icon: mdi:desktop-tower

    light.office_lamp:
      <<: *customize
      friendly_name: "Office Lamp"
      icon: mdi:desktop-tower

    light.pendant_lamp:
      <<: *customize
      friendly_name: "Pendant Lamp"
      icon: mdi:ceiling-light

    light.right_lamp:
      <<: *customize
      friendly_name: "Living Room Right"
      icon: mdi:lamp

    light.basement_tv_bias:
      <<: *customize
      friendly_name: "TV Bias"
      icon: mdi:television

    ################################################
    ## Proximity
    ################################################

    ################################################
    ## Scenes
    ################################################
    scene.night_arrive_home:
      <<: *customize
      friendly_name: Nighttime Arrive Home
      hidden: true

    scene.leave_home:
      <<: *customize
      hidden: true

    scene.chill:
      <<: *customize
      friendly_name: Chill

    scene.bedroom_prep:
      <<: *customize
      friendly_name: Bedroom Prep

    scene.outside_ambiance:
      <<: *customize
      friendly_name: Outside Ambiance

    scene.reset_bedroom:
      <<: *customize
      friendly_name: Reset Bedroom

    scene.scene_reset_basement:
      <<: *customize
      friendly_name: Reset Basement

    scene.scene_reset_bedroom:
      <<: *customize
      friendly_name: Scene Reset Bedroom

    scene.the_walking_dead:
      <<: *customize
      friendly_name: The Walking Dead

    ################################################
    ## Scripts
    ################################################
    script.reset_basement:
      <<: *customize
      friendly_name: "Script Reset Basement"

    ################################################
    ## Sensors
    ################################################

    ################################################
    ## Switches
    ################################################

    switch.deck:
      <<: *customize
      friendly_name: "Deck"
      icon: mdi:nature-people

    switch.front_door:
      <<: *customize
      friendly_name: "Front Door"
      icon: mdi:home

    switch.stairs:
      <<: *customize
      friendly_name: "Stairs"
      icon: mdi:stairs

    ################################################
    ## Thermostats
    ################################################

    ################################################
    ## Zone
    ################################################

################################################
## Adaptive Lighting
################################################
# adaptive_lighting:
#   - name: "Rest of House"
#     lights:
#       - light.kitchen_sink
#       - light.den_all
#       - light.living_room_lamps
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 20
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

#   - name: "Bedroom"
#     lights:
#       - light.owner_suite_all
#       - light.owner_suite_bathroom_lights
#       - light.owner_suite_lamps
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 10
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

#   - name: "Hallways"
#     lights:
#       - light.hall_all_downlights
#       - light.hall_main_foyer
#       - light.hall_upstairs_lights
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 10
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

#   - name: "Basement"
#     lights:
#       - light.basement_all_down_lights
#     prefer_rgb_color: false
#     initial_transition: 1.0
#     sleep_transition: 1.0
#     transition: 45.0
#     interval: 90
#     min_brightness: 10
#     max_brightness: 100
#     min_color_temp: 2000
#     max_color_temp: 5500
#     sleep_brightness: 1
#     sleep_color_temp: 1000
#     # sunrise_time: None
#     sunrise_offset: 0
#     # sunset_time: None
#     sunset_offset: 0
#     only_once: false
#     take_over_control: true
#     detect_non_ha_changes: false
#     seperate_turn_on_commands: false
#     adapt_delay: 0

################################################
## Automation
################################################
automation:
  - id: basement_lights_auto_on
    alias: basement_lights_auto_on
    trigger:
      - platform: state
        entity_id: binary_sensor.basement_landing_occupancy
        to: "on"
    condition:
      - alias: "In bed"
        condition: state
        entity_id:
          - binary_sensor.master_bed_occupancy
        state: "off"
    action:
      - service: homeassistant.turn_on
        data:
          entity_id:
            - light.basement_great_room

  - id: cpap_on_lights_off
    alias: cpap_on_lights_off
    trigger:
      - platform: numeric_state
        entity_id: sensor.owner_suite_cpap_plug_power
        above: 1.3
        for: "00:00:10"
    condition:
      - alias: "Already up"
        condition: state
        entity_id: input_boolean.wakeup_alarm_firing
        state: "off"
      - or:
          - alias: "after sunset"
            condition: sun
            after: sunset
          - alias: "before sunrise"
            condition: sun
            before: sunrise
    action:
      - service: homeassistant.turn_off
        data:
          entity_id:
            - light.owner_suite_lamps

  # - id: deck_light_auto_off
  #   alias: deck_light_auto_off
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.tiki_room_deck_contact
  #       to: "off"
  #       for:
  #         seconds: 30
  #     - platform: state
  #       entity_id: binary_sensor.kitchen_deck_contact
  #       to: "off"
  #       for:
  #         seconds: 30
  #   condition:
  #     condition: state
  #     entity_id: input_boolean.deck_auto_on
  #     state: "on"
  #   action:
  #     - service: homeassistant.turn_off
  #       data:
  #         entity_id:
  #           - switch.deck
  #           - light.deck_string
  #     - service: homeassistant.turn_off
  #       data:
  #         entity_id: input_boolean.deck_auto_on

  - id: deck_light_auto_on
    alias: deck_light_auto_on
    trigger:
      - platform: state
        entity_id: binary_sensor.tiki_room_deck_contact
        to: "on"
      - platform: state
        entity_id: binary_sensor.kitchen_deck_contact
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: sun
          after: sunset
          after_offset: -02:00:00
        - condition: state
          entity_id: switch.deck
          state: "off"
          enabled: false
        - condition: state
          entity_id: light.deck_string
          state: "off"
    action:
      - service: homeassistant.turn_on
        data:
          entity_id:
            - light.deck_string
      # - service: homeassistant.turn_on
      #   data:
      #     entity_id: input_boolean.deck_auto_on

  - id: front_door_light_auto_toggle
    alias: front_door_light_auto_toggle
    trigger:
      - platform: state
        entity_id: binary_sensor.front_door_contact
        to: "off"
        for:
          seconds: 30
        id: door-closed
      - platform: state
        entity_id: binary_sensor.front_door_contact
        to: "on"
        id: door-opened
    condition:
      []
      # condition: state
      # entity_id: input_boolean.front_door_auto_on
      # state: "on"
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: door-closed
            sequence:
              # TODO maybe don't turn off the lights.
              # - service: homeassistant.turn_off
              #   data:
              #     entity_id: light.outside_front_lights
              - service: homeassistant.turn_off
                data:
                  entity_id: input_boolean.front_door_auto_on
      - choose:
          - conditions:
              - condition: trigger
                id: door-opened
            sequence:
              - service: light.turn_on
                data:
                  entity_id:
                    - light.outside_front_lights
                    - light.hall_all_downlights
              - service: homeassistant.turn_on
                data:
                  entity_id: input_boolean.front_door_auto_on

  - id: front_lights_toggle
    alias: front_lights_toggle
    trigger:
      - platform: sun
        event: sunrise
        offset: "00:00:00"
        id: sunrise
      - platform: sun
        event: sunset
        offset: "-01:45:00"
        id: sunset
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: sunrise
            sequence:
              - service: light.turn_off
                data:
                  entity_id: light.outside_front_lights
                  transition: 600
      - choose:
          - conditions:
              - condition: trigger
                id: sunset
            sequence:
              - service: light.turn_on
                data:
                  entity_id: light.outside_front_lights
                  transition: 600

  # - id: front_door_light_auto_on
  #   alias: front_door_light_auto_on
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.front_door_contact
  #       to: "on"
  #   condition:
  #     condition: and
  #     conditions:
  #       - condition: sun
  #         after: sunset
  #       - condition: state
  #         entity_id: switch.front_door
  #         state: "off"
  #   action:
  #     - service: homeassistant.turn_on
  #       data:
  #         entity_id: switch.front_door
  #     - service: homeassistant.turn_on
  #       data:
  #         entity_id: input_boolean.front_door_auto_on

  - id: guest_room_ceiling_lights_on_off
    alias: guest_room_ceiling_lights_on_off
    trigger:
      - platform: event
        event_type: zha_event
        event_data:
          device_ieee: "00:15:8d:00:01:f3:78:cc"
          command: "hold"
    action:
      - service: homeassistant.toggle
        data:
          entity_id:
            - light.guest_ceiling

  - id: guest_room_lights_on_off
    alias: guest_room_lights_on_off
    trigger:
      - platform: event
        event_type: zha_event
        event_data:
          device_ieee: "00:15:8d:00:01:f3:78:cc"
          command: "click"
          args:
            click_type: "single"
    action:
      - service: homeassistant.toggle
        data:
          entity_id:
            - light.guest_side_lamps

  - id: hallway_light_toggle_at_night
    alias: hallway_light_toggle_at_night
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "on"
        id: motion-sensed
      - platform: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "off"
        id: motion-not-detected
    condition:
      - condition: or
        conditions:
          - condition: sun
            after: sunset
            before_offset: "-1:30:00"
          - condition: sun
            before: sunrise
            after_offset: "-0:30:00"
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: motion-sensed
              - condition: or
                conditions:
                  - condition: state
                    entity_id:
                      - binary_sensor.master_bed_occupancy
                    state: "off"
                  - condition: state
                    entity_id:
                      - input_boolean.guest_mode
                    state: "on"
            sequence:
              - service: light.turn_on
                data:
                  entity_id:
                    - light.hall_all_downlights
                  transition: 2.5
                  # Should do this automatically
                  # kelvin: "{{ states('sensor.circadian_temperature') | int }}"
                  # brightness_pct: 2
          - conditions:
              - condition: trigger
                id: motion-not-detected
            sequence:
              - condition: >-
                  "{{ states('binary_sensor.hall_upstairs_motion_occupancy') == states('binary_sensor.hall_main_foyer_motion_occupancy') }}"
              - service: light.turn_off
                data:
                  entity_id:
                    - light.hall_all_downlights
                  transition: 5

  - id: in_bed_turn_off_other_lights
    alias: in_bed_turn_off_other_lights
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.master_bed_occupancy
        to: "on"
        from: "off"
        for: "00:00:15"
    condition:
      - condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
      - or:
          - condition: sun
            after: sunset
            after_offset: "-0:30:00"
          - condition: sun
            before: sunrise
            before_offset: "+2:00:00"
    action:
      - service: light.turn_off
        target:
          area_id:
            - 13b74091cb0d4c85b33aa3c02110dc61
            - 4927cd530ee44a9e9eefc33f0de6c90e
            - 63fed54ed79341e78947d811495a52cd
            - deck
            - den
            - garage
            - 13b74091cb0d4c85b33aa3c02110dc61
            - 7cd73f11a4bf476e839c61b4a3090edd
            - laundry_room
            - 72a8db21bc2d457e80748541dc138d07
            - 54913feabaa14cf88ff2190e25bef547
            - owner_suite_bathroom
            - 8144b95c1eb245499ecaf8d49e4ffe30
            - tiki_room
        data:
          transition: 60

  - id: kitchen_lights_toggle
    alias: kitchen_lights_toggle
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.kitchen_motion_occupancy
        to: "on"
        id: kitchen-occupied
      - platform: state
        entity_id:
          - binary_sensor.kitchen_motion_occupancy
        to: "off"
        for:
          minutes: 60
        id: kitchen_unoccupied
    condition:
    action:
      - choose:
          # IF lunch
          - conditions:
              - condition: trigger
                id: kitchen-occupied
              - condition: template
                value_template: "{{ now().hour >= 11 and now().hour < 14 }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.kitchen_all
          # ELIF dinner
          - conditions:
              - condition: trigger
                id: kitchen-occupied
              - condition: template
                value_template: "{{ now().hour >= 17 and now().hour < 20 }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.kitchen_all
          - conditions:
              - condition: trigger
                id: kitchen-unoccupied
            sequence:
              - service: light.turn_off
                target:
                  entity_id: light.kitchen_all
        default:
          - service: light.turn_on
            target:
              entity_id: light.kitchen_sink

  # - id: kitchen_lights_off
  #   alias: kitchen_lights_off
  #   trigger:
  #     - platform: state
  #       entity_id:
  #         - binary_sensor.kitchen_motion_occupancy
  #       to: "off"
  #       for:
  #         minutes: 60
  #       id: kitchen_unoccupied
  #   action:
  #     - service: light.turn_off
  #       target:
  #         entity_id: light.kitchen_all

  - id: up_enable_owner_bedroom_light_auto_off
    alias: up_enable_owner_bedroom_light_auto_off
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.owner_suite_bathroom_room_occupancy
    condition:
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: state
        entity_id: light.owner_suite_lamps
        state: "on"
      - condition: state
        entity_id: binary_sensor.master_bed_occupancy
        state: "off"
        # enabled: false
    action:
      - service: homeassistant.turn_on
        data:
          entity_id: input_boolean.owner_suite_bedroom_auto_on

  - id: owner_suite_bath_light_auto_off
    alias: owner_suite_bath_light_auto_off
    trigger:
      - platform: state
        entity_id: binary_sensor.owner_suite_bathroom_room_occupancy
        to: "off"
        for:
          minutes: 25
    condition:
      condition: state
      entity_id: input_boolean.owner_bath_auto_on
      state: "on"
    action:
      - service: homeassistant.turn_off
        data:
          entity_id:
            - light.owner_suite_bathroom_lights
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.owner_bath_auto_on

  - id: owner_suite_bath_light_auto_off_in_bed
    alias: owner_suite_bath_light_auto_off_in_bed
    trigger:
      - platform: state
        entity_id: binary_sensor.master_bed_occupancy
        to: "on"
        for:
          minutes: 2
    condition:
      condition: state
      entity_id: input_boolean.owner_bath_auto_on
      state: "on"
    action:
      - service: homeassistant.turn_off
        data:
          entity_id:
            - light.owner_suite_bathroom_lights
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.owner_bath_auto_on

  - id: owner_suite_bath_light_auto_on
    alias: owner_suite_bath_light_auto_on
    trigger:
      - platform: state
        entity_id: binary_sensor.owner_suite_bathroom_room_occupancy
        to: "on"
    # condition:
    #   condition: and
    #   conditions:
    #     - condition: sun
    #       after: sunset
    action:
      - service: homeassistant.turn_on
        data:
          entity_id:
            - light.owner_suite_bathroom_lights
      - service: homeassistant.turn_on
        data:
          entity_id: input_boolean.owner_bath_auto_on

  - id: owner_suite_light_auto_off
    alias: owner_suite_light_auto_off
    trigger:
      - platform: state
        entity_id: binary_sensor.bedroom_occupancy
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.owner_suite_bedroom_auto_on
          state: "on"
        - condition: state
          entity_id: binary_sensor.master_bed_occupancy
          state: "off"
          # enabled: false
    action:
      - service: light.turn_off
        data:
          entity_id:
            - light.owner_suite_lamps
            - light.owner_suite_ceiling
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.owner_suite_bedroom_auto_on

  - id: owner_suite_light_auto_off_in_morning
    alias: owner_suite_light_auto_off_in_morning
    trigger:
      - platform: state
        entity_id: binary_sensor.bedroom_occupancy
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: time
          after: "00:06:00"
          before: "12:00:00"
        - condition: state
          entity_id: binary_sensor.master_bed_occupancy
          state: "off"
          # enabled: false
    action:
      - service: light.turn_off
        data:
          entity_id:
            - light.owner_suite_lamps
            - light.owner_suite_ceiling

  - id: owner_suite_light_auto_boolean_off
    alias: owner_suite_light_auto_boolean_off
    trigger:
      - platform: state
        entity_id: binary_sensor.bedroom_occupancy
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.owner_suite_bedroom_auto_on
          state: "on"
        - condition: state
          entity_id: binary_sensor.master_bed_occupancy
          state: "off"
          # enabled: false
    action:
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.owner_suite_bedroom_auto_on

  - id: owner_suite_light_auto_on
    alias: owner_suite_light_auto_on
    trigger:
      - platform: state
        entity_id: binary_sensor.bedroom_occupancy
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: device_tracker.bayesian_zeke_home
          zone: zone.home
        - condition: state
          entity_id: light.owner_suite_lamps
          state: "off"
        - condition: state
          entity_id: binary_sensor.master_bed_occupancy
          state: "off"
          # enabled: false
    action:
      - service: light.turn_on
        data:
          entity_id: light.owner_suite_lamps
          kelvin: >-
            {{ state_attr('switch.adaptive_lighting_owner_suite','color_temp_kelvin') | int }}
          brightness_pct: >-
            {{ state_attr('switch.adaptive_lighting_owner_suite', 'brightness_pct') | int }}
      - service: homeassistant.turn_on
        data:
          entity_id: input_boolean.owner_suite_bedroom_auto_on

  # TODO remove as no longer needed?

  # - id: office_light_on_at_night
  #   alias: office_light_on_at_night
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.office_motion_occupancy
  #       to: "on"
  #   condition:
  #     condition: sun
  #     before: sunrise
  #     after_offset: "-0:30:00"
  #   action:
  #     - service: light.turn_on
  #       data_template:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling
  #         kelvin: >-
  #           {{ state_attr('switch.adaptive_lighting_rest_of_house','color_temp_kelvin') | int }}
  #         brightness_pct: >-
  #           {{ state_attr('switch.adaptive_lighting_rest_of_house', 'brightness_pct') | int }}

  # - id: office_light_off_at_night
  #   alias: office_light_off_at_night
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.office_motion_occupancy
  #       to: "off"
  #   condition:
  #     condition: sun
  #     before: sunrise
  #     after_offset: "-0:30:00"
  #   action:
  #     - service: homeassistant.turn_off
  #       data:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling

  # - id: reset_office_light_at_night
  #   alias: reset_office_light_at_night
  #   trigger:
  #     - platform: time
  #       at: "03:48:00"
  #   action:
  #     - service: light.turn_on
  #       data:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling
  #         brightness: 1
  #     - delay:
  #         seconds: 10
  #     - service: light.turn_off
  #       data:
  #         entity_id:
  #           - light.office_lamp
  #           - light.office_ceiling

  - alias: toggle_living_room
    id: toggle_living_room
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.living_room_button_push
    action:
      - service: light.toggle
        entity_id: light.living_room_all
        data:
          transition: 5

  - alias: toggle_kitchen
    id: toggle_kitchen
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.kitchen_button
    action:
      - service: light.toggle
        entity_id: light.kitchen_table
        data:
          transition: 5

  - alias: toggle_office
    id: toggle_office
    trigger:
      - platform: event
        event_type: zha_event
        event_data:
          device_ieee: "00:15:8d:00:02:13:90:e9"
          command: "attribute_updated"
    action:
      - service: light.toggle
        entity_id: light.office
        data:
          transition: 5

  - alias: transition_on_lights_when_home_near_sunset
    id: transition_on_lights_when_home_near_sunset
    trigger:
      platform: sun
      event: sunset
      offset: "-02:00:00"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: person.ryan
          zone: zone.home
        # - condition: numeric_state
        #   entity_id: sensor.dark_sky_cloud_coverage
        #   below: 20
    action:
      - service: light.turn_on
        entity_id:
          - light.kitchen_sink
          - light.hall_all_downlights
          - light.living_room_lamps
          - light.den_all
          # - light.kitchen_table
          # - light.living_room_all
        data:
          # Hour-long transition before sunset.
          transition: 5400

  - alias: transition_on_lights_early_when_cloudy_when_home_near_sunset
    id: transition_on_lights_early_when_cloudy_when_home_near_sunset
    trigger:
      platform: sun
      event: sunset
      offset: "-04:00:00"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: person.ryan
          zone: zone.home
        - condition: numeric_state
          entity_id: sensor.dark_sky_cloud_coverage
          above: 20
    action:
      - service: light.turn_on
        entity_id:
          - light.kitchen_sink
          - light.hall_all_downlights
          - light.living_room_lamps
          - light.den_all
          # - light.kitchen_table
          # - light.living_room_all
        data:
          # Hour-long transition before sunset.
          transition: 5400

  - alias: turn_off_alarm_firing
    id: turn_off_alarm_firing
    trigger:
      - platform: time
        at: "14:34:56"
    action:
      - alias: "Turn off Alarm Boolean"
        service: input_boolean.turn_off
        target:
          entity_id: input_boolean.wakeup_alarm_firing

  # TODO figure out a way to avoid the: motion downstairs but upstairs has turned off so I'm going to turn off everything.
  - alias: toggle_hallway_day
    id: toggle_hallway_day
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "on"
        id: hallway-motion
      - platform: state
        entity_id:
          - binary_sensor.hall_main_foyer_motion_occupancy
          - binary_sensor.hall_upstairs_motion_occupancy
        to: "off"
        for:
          seconds: 120
        id: hallway-no-motion
    condition:
      - condition: sun
        after: sunrise
        before: sunset
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: hallway-motion
            sequence:
              - service: light.turn_on
                data:
                  entity_id:
                    - light.hall_lights_all
                  transition: 1.5
          - conditions:
              - condition: trigger
                id: hallway-no-motion
            sequence:
              - condition: >-
                  {{ states('binary_sensor.hall_upstairs_motion_occupancy') == states('binary_sensor.hall_main_foyer_motion_occupancy') }}
              - service: light.turn_off
                data:
                  entity_id:
                    - light.hall_lights_all
                  transition: 5

  # - alias: turn_off_hallway_on_motion_day
  #   id: turn_off_hallway_on_motion_day
  #   trigger:
  #     - platform: state
  #       entity_id:
  #         - binary_sensor.hall_main_foyer_motion_occupancy
  #         - binary_sensor.hall_upstairs_motion_occupancy
  #       to: "off"
  #       for:
  #         seconds: 90
  #   condition:
  #     - condition: sun
  #       after: sunrise
  #       before: sunset
  #   action:
  #     - service: light.turn_off
  #       data:
  #         entity_id:
  #           - light.hall_lights_all

  - alias: turn_off_sleep_mode
    id: turn_off_sleep_mode
    trigger:
      - platform: time
        at: "07:00:00"
    action:
      - service: switch.turn_off
        data:
          entity_id:
            - switch.adaptive_lighting_sleep_mode_basement
            - switch.adaptive_lighting_sleep_mode_den
            - switch.adaptive_lighting_sleep_mode_hallway
            - switch.adaptive_lighting_sleep_mode_kitchen
            - switch.adaptive_lighting_sleep_mode_owner_suite
            - switch.adaptive_lighting_sleep_mode_living_room

  - alias: button_reset_basement
    id: button_reset_basement
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.basement_button_hold
    action:
      - service: scene.turn_on
        entity_id: scene.scene_reset_basement
        data:
          transition: 10

  - id: turn_off_all_lights_when_bed_off
    alias: turn_off_all_lights_when_bed_off
    trigger:
      - platform: state
        entity_id: light.owner_suite_lamps
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: time
          after: "22:00:00"
          before: "06:00:00"
        - condition: state
          entity_id: binary_sensor.master_bed_occupancy
          state: "on"
          # enabled: false
          # Don't turn off all the lights if there are guests in the house. Specifically the office/guest room
        - condition: state
          entity_id:
            - input_boolean.guest_mode
          state: "on"
    action:
      - parallel:
          # - service: scene.turn_on
          #   entity_id: scene.good_night
          - service: script.lights_off_except
            data:
              exclude_lights:
                - light.outside_front_lights
          # - service: light.turn_off
          #   entity_id: "all"
          - service: fan.turn_off
            entity_id:
              - fan.den_ceiling
          - service: switch.turn_on
            data:
              entity_id:
                - switch.adaptive_lighting_sleep_mode_basement
                - switch.adaptive_lighting_sleep_mode_den
                - switch.adaptive_lighting_sleep_mode_hallway
                - switch.adaptive_lighting_sleep_mode_kitchen
                - switch.adaptive_lighting_sleep_mode_owner_suite
                - switch.adaptive_lighting_sleep_mode_living_room
          - service: switch.turn_off
            entity_id:
              - switch.stairs
              - switch.front_door
              - switch.deck_string
              - switch.office_lava_lamp
          - service: media_player.turn_off
            entity_id:
              - media_player.lg_webos_smart_tv
              - media_player.basement
        # Only turn on the humidifier when it's winter
        # Not used with whole-home humidifier
        # - condition: and
        #   conditions:
        #     - condition: state
        #       entity_id: sensor.season
        #       state: "winter"
        # - service: switch.turn_on
        #   entity_id:
        #     - switch.humidifier

  - id: turn_on_bedroom_light_when_leave_bathroom
    alias: turn_on_bedroom_light_when_leave_bathroom
    trigger:
      - platform: state
        entity_id: binary_sensor.owner_suite_occupancy
        to: "on"
      - platform: state
        entity_id: binary_sensor.hallway_motion
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: device_tracker.bayesian_zeke_home
          zone: zone.home
        - condition: state
          entity_id: switch.bathroom_light_fan_switch
          state: "off"
        - condition: state
          entity_id: light.owner_suite_lamps
          state: "off"
          enabled: false
    action:
      - service: light.turn_on
        data:
          entity_id: light.owner_suite_lamps
          transition: 5
          kelvin: >-
            {{ state_attr('switch.adaptive_lighting_owner_suite','color_temp_kelvin') | int }}
          brightness_pct: >-
            {{ state_attr('switch.adaptive_lighting_owner_suite', 'brightness_pct') | int }}
      - service: homeassistant.turn_on
        data:
          entity_id: input_boolean.owner_bath_auto_on

  - id: turn_off_basement_light_when_dark_in_room
    alias: turn_off_basement_light_when_dark_in_room
    trigger:
      - platform: state
        entity_id: binary_sensor.downstairs_motion
        to: "off"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: device_tracker.bayesian_zeke_home
          zone: zone.home
        - condition: time
          before: "23:30:00"
        - condition: state
          entity_id: input_boolean.basement_auto_on
          state: "on"
    action:
      - service: switch.turn_off
        data:
          entity_id: switch.stairs
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.basement_auto_on

  - id: turn_off_office_light_when_not_occupied
    alias: turn_off_office_light_when_not_occupied
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.office_motion_occupancy
          - binary_sensor.office_occupancy
        to: "off"
        for:
          minutes: 10
    condition:
      condition: and
      conditions:
        # Turn off auto-off when on a trip so it looks like I'm working
        - condition: state
          entity_id: input_boolean.trip
          state: "off"
        - condition: state
          entity_id: binary_sensor.workday_sensor
          state: "off"
        - condition: time
          after: "07:00:00"
          before: "17:00:00"
    action:
      - service: light.turn_off
        data:
          entity_id:
            - light.office
            - light.office_ceiling
          transition: 5
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.office_auto_on

  - id: turn_on_basement_light_when_dark_in_room
    alias: turn_on_basement_light_when_dark_in_room
    trigger:
      - platform: state
        entity_id: binary_sensor.downstairs_motion
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: zone
          entity_id: device_tracker.bayesian_zeke_home
          zone: zone.home
        - condition: numeric_state
          entity_id: sensor.downstairs_motion_illumination
          below: 4
        - condition: time
          before: "22:00:00"
        - condition: time
          after: "09:00:00"
        - condition: state
          entity_id: switch.stairs
          state: "off"
        - condition: state
          entity_id: switch.stairs
          state: "off"
    action:
      - service: switch.turn_on
        data:
          entity_id: switch.stairs
      - service: homeassistant.turn_on
        data:
          entity_id: input_boolean.basement_auto_on

  - alias: "Tiki Room Animation Speed"
    initial_state: True
    trigger:
      - platform: state
        entity_id: input_number.tikiroom_ani_speed
    action:
      - service: mqtt.publish
        data_template:
          topic: "leds/tikiroom/set"
          payload: '{"transition":{{ trigger.to_state.state | int }}}'

########################
# Binary Sensors
########################
binary_sensor:

########################
# Device Trackers
########################
device_tracker:

########################
# Groups
########################
group:
  external:
    name: External
    entities:
      - switch.deck_string
      - switch.front_door

  Living Room: ## TODO is this group needed anymore? or should I change its members?
    entities:
      - light.living_room_all
      - light.tv
      - light.pendant_lamp
      - light.left_lamp
      - light.right_lamp
      - switch.christmas_tree
      - light.christmas_lights
  ## TODO is this group needed anymore? or should I change it?
  owner_suite:
    name: Master Bedroom
    entities:
      - light.owner_suite_lamps
      - light.owner_suite_ceiling

  guest_bedroom:
    name: Guest Bedroom
    entities:
      - light.guest_room_ceiling
      - light.guest_left_lamp
      - light.guest_right_lamp

  kitchen:
    name: Kitchen
    entities:
      - light.kitchen_table
      - light.kitchen_sink

  other_lights:
    name: Other Lights
    entities:
      - switch.stairs
      - light.hall_lights_all
      - light.office_floor_lamp
      - light.office_ceiling

########################
# Input Booleans
########################
input_boolean:
  deck_auto_on:
  front_door_auto_on:
  owner_bath_auto_on:
  basement_auto_on:
  office_auto_on:
  owner_suite_bedroom_auto_on:
########################
# Input Numbers
########################
input_number:
  tikiroom_ani_speed:
    name: Tiki Room Animation Speed
    initial: 150
    min: 1
    max: 150
    step: 10
########################
# Light
########################
light:
  - platform: group
    name: kitchen_overhead
    entities:
      - light.south_kitchen
      - light.north_kitchen

  - platform: group
    name: kitchen_all
    entities:
      - light.south_kitchen
      - light.north_kitchen
      - light.kitchen_sink

  - platform: group
    name: living_room_all
    entities:
      - light.living_room_flanking_tv
      - light.tv
      - light.pendant_lamp

  - platform: group
    name: living_room_all_except_tv
    entities:
      - light.living_room_flanking_tv
      - light.pendant_lamp

  - platform: group
    name: office
    entities:
      - light.office_lava_lamp
      - light.office_floor_lamp
      - light.office_ceiling

  - platform: group
    name: guest_bedroom
    entities:
      - light.guest_room_ceiling
      - light.guest_left_lamp
      - light.guest_right_lamp

  - platform: switch
    name: Office Lava Lamp
    entity_id: switch.office_lava_lamp

  # - platform: mqtt
  #   schema: json
  #   name: "Tiki Room Strip"
  #   state_topic: "leds/tikiroom"
  #   command_topic: "leds/tikiroom/set"
  #   effect: true
  #   effect_list:
  #     - bpm
  #     - candy cane
  #     - confetti
  #     - cyclon rainbow
  #     - dots
  #     - fire
  #     - glitter
  #     - juggle
  #     - lightning
  #     - noise
  #     - police all
  #     - police one
  #     - rainbow
  #     - rainbow with glitter
  #     - ripple
  #     - sinelon
  #     - solid
  #     - twinkle
  #   brightness: true
  #   #flash: true
  #   rgb: true
  #   optimistic: false
  #   qos: 0

########################
# MQTT
########################
mqtt:
  light:
    - name: "Tiki Room Strip"
      schema: json
      state_topic: "leds/tikiroom"
      command_topic: "leds/tikiroom/set"
      # command_off_template: '{"state": "OFF"}'
      # command_on_template: '{"state": "ON"}'
      # effect: true
      brightness: true
      effect: true
      effect_list:
        - bpm
        - candy cane
        - confetti
        - cyclon rainbow
        - dots
        - fire
        - glitter
        - juggle
        - lightning
        - noise
        - police all
        - police one
        - rainbow
        - rainbow with glitter
        - ripple
        - sinelon
        - solid
        - twinkle
      #brightness: true
      #flash: true
      color_mode: true
      supported_color_modes: ["rgb", "color_temp"]
      optimistic: false
      qos: 0
########################
# Proximity
########################
proximity:

########################
# Scenes
########################
scene:
  - name: scene_reset_bedroom
    entities:
      light.owner_suite_ceiling:
        state: "off"
      light.owner_suite_lamps:
        state: "on"
        brightness: 192
        color_temp: 500

  - name: scene_reset_basement
    entities:
      light.basement_all_down_lights:
        state: "on"
        color_temp: 386
        brightness: 255
      light.basement_tv_bias:
        state: "on"
        hs_color: [360, 100]
        brightness: 128

  - name: the_walking_dead
    entities:
      light.right_lamp:
        state: "on"
        brightness: 64
        rgb_color: [255, 0, 0]
      light.left_lamp:
        state: "on"
        brightness: 64
        rgb_color: [255, 0, 0]
      light.pendant_lamp:
        state: "on"
        brightness: 64
        rgb_color: [255, 0, 0]
      light.basement_tv_bias:
        state: "on"
        brightness: 64
        rgb_color: [255, 0, 0]

  - name: chill
    entities:
      light.living_room_flanking_tv:
        state: "on"
        brightness: 64
        transition: 120

  - name: cloudy_arrive_home
    entities:
      light.kitchen_sink:
        state: "on"
        brightness: 255
      light.hall_lights_all:
        state: "on"
        brightness: 255
      light.den_all:
        state: "on"
      switch.stairs:
        state: "on"

  - name: outside_ambiance
    entities:
      light.deck_string:
        state: "on"

  - name: night_arrive_home
    entities:
      light.hall_lights_all:
        state: "on"
        brightness: 255
      light.den_all:
        state: "on"
      light.kitchen_sink:
        state: "on"
        brightness: 255
      light.owner_suite_lamps:
        state: "on"
        brightness: 255
      switch.front_door:
        state: "on"

  - name: bedroom_prep
    entities:
      light.owner_suite_lamps:
        state: "on"
        brightness: 25
      cover.owner_suite_blinds:
        state: "closed"
      fan.owner_suite:
        state: "on"
      light.owner_suite_bathroom_lights:
        state: "on"
        brightness: 204
      light.owner_suite_ceiling:
        state: "off"
      # fan.master_bedroom_fan:
      #   state: "on"
      #   speed: "smart"

########################
# Scripts
########################
script:
  reset_basement:
    sequence:
      - service: scene.turn_on
        target:
          entity_id: scene.scene_reset_basement
        data:
          transition: 15

  lights_off_except:
    icon: mdi:home-lightbulb
    mode: parallel
    fields:
      exclude_lights:
        description: "Excluded lights as list"
    variables:
      all_other_lights: >
        {%- for device in states.light|rejectattr('entity_id','in', exclude_lights )|rejectattr('state','in','off') %}{%- if loop.first %}{%- else %}, {% endif %}{{ device.entity_id }}{%- if loop.last %}{% endif %}{%- endfor  %}
    sequence:
      - service: logbook.log
        data:
          entity_id: script.lights_off_except
          name: Exclude log
          message: "Turning of all lights except: {{ exclude_lights }}"
          domain: script
      - service: light.turn_off
        data_template:
          entity_id: >
            {{all_other_lights}}
      - service: light.turn_off
        data_template:
          entity_id: >
            {{all_other_lights}}

########################
# Sensor
########################
sensor:
  - platform: template
    sensors:
      circadian_brightness:
        friendly_name: "Circadian Brightness"
        unit_of_measurement: "%"
        value_template: "{{ state_attr('switch.adaptive_lighting_hallway', 'brightness_pct') |int }}"
      circadian_temperature:
        friendly_name: "Circadian Color Temp"
        unit_of_measurement: "°K"
        value_template: "{{ state_attr('switch.adaptive_lighting_hallway', 'color_temp_kelvin') }}"

########################
# Switch
########################
switch:

########################
# Zone
########################
zone:
