################################################################
## Packages / Guest
################################################################

################################################
## Customize
################################################

homeassistant:
  customize:
    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: "guest"

      expose: &expose
        <<: *customize
        haaska_hidden: false
        homebridge_hidden: false

    ################################################
    ## Alarm Panels
    ################################################

    ################################################
    ## Automations
    ################################################

    ################################################
    ## Binary Sensors
    ################################################

    ################################################
    ## Cameras
    ################################################

    ################################################
    ## Device Trackers
    ################################################

    ################################################
    ## Frontend
    ################################################

    ################################################
    ## Groups
    ################################################

    ################################################
    ## Input Boolean
    ################################################
    input_boolean.guest_mode:
      <<: *customize
      friendly_name: "Guest Mode"
      icon: mdi:account-alert
      #persistent: true

    ################################################
    ## Input Numbers
    ################################################

    ################################################
    ## Input Select
    ################################################

    ################################################
    ## iOS
    ################################################

    ################################################
    ## Light
    ################################################

    ################################################
    ## Plant
    ################################################

    ################################################
    ## Proximity
    ################################################

    ################################################
    ## Scripts
    ################################################

    ################################################
    ## Sensors
    ################################################

    ################################################
    ## Thermostats
    ################################################

    ################################################
    ## Zone
    ################################################

########################
# Alarm Panel
########################
alarm_control_panel: []

########################
## Automation
########################
automation:
  - id: turn_off_guest_mode_when_guest_wifi_inactive
    alias: turn_off_guest_mode_when_guest_wifi_inactive
    trigger:
      - trigger: state
        entity_id: binary_sensor.guest_on_wifi
        to: "off"
        for:
          hours: 16
    # condition:
    action:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.guest_mode
      - action: notify.all
        data:
          message: Guest Mode Deactivated
      - action: media_player.join
        target:
          entity_id:
            - media_player.bedroom_sonos
        data:
          group_members:
            - media_player.bathroom_sonos
            - media_player.office_sonos
            - media_player.den_sonos

  - id: turn_on_guest_mode_when_guest_wifi_active
    alias: turn_on_guest_mode_when_guest_wifi_active
    mode: restart
    trigger:
      - trigger: state
        entity_id: binary_sensor.guest_on_wifi
        to: "on"
        for:
          minutes: 10
    #condition:
    action:
      - action: notify.mobile_app_wethop
        data:
          title: "Guest Mode Activated"
          message: "Leave enabled?"
          data:
            actions:
              - action: "ENABLE_GUEST"
                title: "Yes"
                activationMode: background
                authenticationRequired: false
                destructive: false
                behavior: default
              - action: "DISABLE_GUEST"
                title: "No"
                activationMode: background
                authenticationRequired: false
                destructive: false
                behavior: default
      - wait_for_trigger:
          - trigger: event
            event_type: mobile_app_notification_action
            id: enable_guest
            event_data:
              action: ENABLE_GUEST
        timeout:
          hours: 1
        continue_on_timeout: false
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.guest_mode
      - action: media_player.unjoin
        target:
          entity_id:
            - media_player.bedroom_sonos
            - media_player.bathroom_sonos
            - media_player.office_sonos
            - media_player.den_sonos
      - action: media_player.join
        target:
          entity_id:
            - media_player.bedroom_sonos
        data:
          group_members:
            - media_player.bathroom_sonos
      # - action: media_player.join
      #   target:
      #     entity_id:
      #       - media_player.office
      #   data:
      #     group_members:
      #       - media_player.den

  - id: climate_guest_mode_day
    alias: climate_guest_mode_day
    trigger:
      - trigger: state
        entity_id: input_boolean.guest_mode
        to: "on"
        for:
          seconds: 20
      - trigger: time
        at: 07:00:00
    condition:
      - condition: time
        after: "06:00:00"
        before: "00:00:00"
      - condition: state
        entity_id:
          - input_boolean.guest_mode
        state: "on"
    action:
      - action: climate.set_preset_mode
        data:
          preset_mode: "Guest Day"
        target:
          entity_id: climate.my_ecobee

  - id: climate_guest_mode_night
    alias: climate_guest_mode_night
    trigger:
      - trigger: state
        entity_id: input_boolean.guest_mode
        to: "on"
        for:
          seconds: 20
      - trigger: time
        at: 00:00:00
    condition:
      - condition: time
        after: "00:00:00"
        before: "07:00:00"
      - condition: state
        entity_id:
          - input_boolean.guest_mode
        state: "on"
    action:
      - action: climate.set_preset_mode
        data:
          preset_mode: "Guest Sleep"
        target:
          entity_id: climate.my_ecobee

########################
# Binary Sensors
########################
binary_sensor: []

########################
# Cameras
########################
camera: []

########################
# Device Trackers
########################
device_tracker: []

########################
# Frontend
########################
frontend: {}

########################
# Groups
########################
group: {}

########################
# Input Booleans
########################
input_boolean:
  guest_mode:

########################
# Input Numbers
########################
input_number: {}

########################
# Input Select
########################
input_select: {}

########################
# iOS
########################
ios: {}

########################
# Light
########################
light: []

########################
# Plant
########################
plant: {}

########################
# Scenes
########################
scene: []

########################
# Scripts
########################
script: {}

########################
# Sensor
########################
sensor: []

########################
# Switch
########################
switch: []

################################################
## Templates
################################################
template:
  - binary_sensor:
      - default_entity_id: binary_sensor.guest_on_wifi
        state: >-
          {% set state = states('sensor.barley_guest') %} {% if is_number(state) and state | float >= 1 %}
            True
          {% else %}
            False
          {% endif %}"
        name: guest_on_wifi
  - sensor:
      - name: guests_on_wifi
        state: >-
          {{ (states.device_tracker | selectattr('state','eq','home') | selectattr('attributes.is_guest', 'eq', true) | list) }}

########################
# Zone
########################
zone: {}
